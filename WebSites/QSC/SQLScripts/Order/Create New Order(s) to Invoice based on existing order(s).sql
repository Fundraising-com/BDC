USE [QSPCanadaOrderManagement]

SELECT	coh.CampaignID,
		cod.PricingDetailsID,
		cod.Renewal,
		cod.Price,
		cod.PriceOverrideID,
		CASE 
			WHEN coh.CustomerBillToInstance = 0 THEN custCod.Instance
			ELSE custCoh.Instance
		END AS CustomerInstance,
		cod.ProductType,
		612 AS UserProfileID,
		LEFT(COALESCE(cod.Recipient,''), CHARINDEX(' ', COALESCE(cod.Recipient,''),CHARINDEX(' ', COALESCE(cod.Recipient,''),1))) AS FirstName,
		LTRIM(RIGHT(COALESCE(cod.Recipient,''), LEN(REPLACE(COALESCE(cod.Recipient,''), ' ', '_')) - COALESCE(CHARINDEX(' ', COALESCE(cod.Recipient,''),1), 0))) as LastName,
		CASE 
			WHEN coh.CustomerBillToInstance = 0 THEN custCod.Address1
			ELSE custCoh.Address1
		END AS Address1,
		CASE 
			WHEN coh.CustomerBillToInstance = 0 THEN custCod.Address2
			ELSE custCoh.Address2
		END AS Address2,
		CASE 
			WHEN coh.CustomerBillToInstance = 0 THEN custCod.City
			ELSE custCoh.City
		END AS City,
		CASE 
			WHEN coh.CustomerBillToInstance = 0 THEN custCod.State
			ELSE custCoh.State
		END AS State,
		CASE 
			WHEN coh.CustomerBillToInstance = 0 THEN custCod.Zip
			ELSE custCoh.Zip
		END AS Zip,
		cod.CustomerOrderHeaderInstance,
		cod.TransID		
INTO	#OriginalSubs
FROM	CustomerOrderDetail cod
JOIN	CustomerOrderHeader coh
			ON	coh.Instance = cod.CustomerOrderHeaderInstance
JOIN	Customer custCoh
			ON	custCoh.Instance = coh.CustomerBillToInstance
JOIN	Customer custCod
			ON	custCod.Instance = cod.CustomerShipToInstance
WHERE	cod.ProductCode = '4288'
AND		coh.Instance IN (
10032339,
10032300,
10032301,
10032274,
10032251,
10032062,
10031982,
10031942,
10031885,
10031781,
10031568,
10031450,
10031413,
10031410,
10031281,
10031196,
10031137,
10029989,
10029960,
10029951,
10029865,
10029712,
10029620,
10029613,
10029586,
10029573,
10029546,
10029219,
10029198,
10029090,
10028947,
10028857,
10028557,
10028512,
10028283,
10027200,
10026930,
10026385,
10026034,
10026031,
10025784,
10025575,
10023822,
10023506,
10023373,
10023354,
10023107,
10023091,
10023079,
10022842,
10022813,
10022627,
10022550,
10022441,
10022381,
10022260,
10022147,
10022121,
10022038,
10022040,
10021939,
10021853,
10021854,
10021830,
10020163,
10020106,
10020065,
10019800,
10019780,
10019539,
10019445,
10019435,
10019337,
10019281,
10019277,
10019241,
10019208,
10017539,
10017501,
10017500,
10017453,
10017394,
10017277,
10017090,
10017078,
10016793,
10016722,
10016710,
10016576,
10016476,
10016385,
10016238,
10015945,
10015876,
10015311,
10015281,
10015231,
10015126,
10012579,
10012530,
10012402,
10012397,
10012284,
10012159,
10012019,
10011910,
10011861,
10011747,
10011683,
10011423,
10011324,
10011255,
10011200,
10011203,
10011186,
10011024,
10010978,
10010734,
10010424,
10010397,
10010261,
10010142,
10010060,
10009862,
10009738,
10009728,
10009572,
10009507,
10009107,
10008833,
10008687,
10008608,
10008609,
10008189,
10008078,
10007927,
10007686,
10007627,
10007584,
10007509,
10007395,
10007285,
10007111,
10004964,
10004924,
10004861,
10004578,
10004580,
10004555,
10004405,
10004345,
10004147,
10004086,
10004087,
10004065,
10004048,
10004004,
10003805,
10003419,
10003219,
10002998,
10002886,
10002805,
10002676,
10002647,
10002413
)

SELECT	*
FROM	#OriginalSubs

BEGIN TRAN t1
DECLARE	@lCampaignID 						INT,
		@lProductpriceInstance 				INT,
		@zNewRenewal 						VARCHAR(1),
		@dPrice 							FLOAT,
		@lOverrideCode 						INT,
		@lCustomerInstance 					INT,
		@zProductType 						VARCHAR(10),
		@lUserProfileID 					INT,
		@sFirstName 						NVARCHAR(50),
		@sLastName 							NVARCHAR(50),
		@sAddress1							NVARCHAR(50),
		@sAddress2							NVARCHAR(50),
		@sCity								NVARCHAR(50),
		@sStateCode							NVARCHAR(5),
		@sZip								NVARCHAR(20),
		@iOrderQualifierID 					INT,
		@iOldCustomerOrderHeaderInstance	INT,
		@iOldTransID						INT

SET @iOrderQualifierID = 39008

DECLARE OriginalSubs CURSOR FOR
	SELECT	CampaignID,
			PricingDetailsID,
			Renewal,
			Price,
			PriceOverrideID,
			CustomerInstance,
			ProductType,
			UserProfileID,
			FirstName,
			LastName,
			Address1,
			Address2,
			City,
			State,
			Zip,
			@iOrderQualifierID,
			CustomerOrderHeaderInstance,
			TransID
	FROM	#OriginalSubs

	OPEN	OriginalSubs
	FETCH	Next FROM OriginalSubs INTO @lCampaignID,
										@lProductpriceInstance,
										@zNewRenewal,
										@dPrice,
										@lOverrideCode,
										@lCustomerInstance,
										@zProductType,
										@lUserProfileID,
										@sFirstName,
										@sLastName,
										@sAddress1,
										@sAddress2,
										@sCity,
										@sStateCode,
										@sZip,
										@iOrderQualifierID,
										@iOldCustomerOrderHeaderInstance,
										@iOldTransID

	WHILE @@Fetch_Status = 0
	BEGIN	
		EXEC pr_AddNewItemForCustomerService
			@lCampaignID = @lCampaignID,
			@lProductpriceInstance = @lProductpriceInstance,
			@zNewRenewal = @zNewRenewal,
			@dPrice = @dPrice,
			@lOverrideCode = @lOverrideCode,
			@lCustomerInstance = @lCustomerInstance,
			@zProductType = @zProductType,
			@lUserProfileID = @lUserProfileID,
			@sFirstName = @sFirstName,
			@sLastName = @sLastName,
			@sAddress1 = @sAddress1,
			@sAddress2 = @sAddress2,
			@sCity = @sCity,
			@sStateCode = @sStateCode,
			@sZip = @sZip,
			@iOrderQualifierID = @iOrderQualifierID,
			@iOldCustomerOrderHeaderInstance = @iOldCustomerOrderHeaderInstance,
			@iOldTransID = @iOldTransID
		FETCH Next FROM OriginalSubs INTO @lCampaignID,
										@lProductpriceInstance,
										@zNewRenewal,
										@dPrice,
										@lOverrideCode,
										@lCustomerInstance,
										@zProductType,
										@lUserProfileID,
										@sFirstName,
										@sLastName,
										@sAddress1,
										@sAddress2,
										@sCity,
										@sStateCode,
										@sZip,
										@iOrderQualifierID,
										@iOldCustomerOrderHeaderInstance,
										@iOldTransID
	END
CLOSE OriginalSubs
DEALLOCATE OriginalSubs
COMMIT TRAN t1